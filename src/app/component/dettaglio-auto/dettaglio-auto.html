<div class="dettaglio-auto-container">
  <div class="container">
    <!-- Loading -->
    @if (loading()) {
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Caricamento...</span>
        </div>
      </div>
    }

    <!-- Errore -->
    @if (error()) {
      <div class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {{ error() }}
      </div>
    }

    @if (!loading() && !error() && car()) {
      <!-- Header -->
      <div class="page-header">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h1 class="page-title">
              <i class="bi bi-car-front-fill me-2"></i>
              {{ car()!.marca }} {{ car()!.modello }}
            </h1>
            <p class="page-subtitle">Targa: <strong class="text-uppercase">{{ car()!.targa }}</strong></p>
          </div>
          <button class="btn btn-outline-secondary" (click)="goBack()">
            <i class="bi bi-arrow-left me-2"></i>
            Torna all'elenco
          </button>
        </div>
      </div>

      <!-- Alert messaggi -->
      @if (successMessage()) {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle-fill me-2"></i>
          {{ successMessage() }}
          <button type="button" class="btn-close" (click)="successMessage.set(null)"></button>
        </div>
      }

      @if (errorMessage()) {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-circle-fill me-2"></i>
          {{ errorMessage() }}
          <button type="button" class="btn-close" (click)="errorMessage.set(null)"></button>
        </div>
      }

      <!-- Accordion Sections -->
      <div class="accordion-sections">
        
        <!-- SEZIONE ANAGRAFICA -->
        <div class="accordion-card">
          <div class="accordion-header" (click)="toggleAnagrafica()">
            <div class="d-flex align-items-center">
              <i class="bi bi-file-text-fill me-2"></i>
              <span class="accordion-title">Anagrafica Auto</span>
            </div>
            <i class="bi" [class.bi-chevron-up]="anagraficaOpen()" [class.bi-chevron-down]="!anagraficaOpen()"></i>
          </div>

          @if (anagraficaOpen()) {
            <div class="accordion-body">
              <!-- Pulsanti azione -->
              <div class="d-flex justify-content-end mb-3">
                @if (!editMode()) {
                  <button class="btn btn-sm btn-primary" (click)="toggleEditMode()">
                    <i class="bi bi-pencil me-1"></i>
                    Modifica
                  </button>
                } @else {
                  <button class="btn btn-sm btn-success me-2" (click)="saveAnagrafica()">
                    <i class="bi bi-check-lg me-1"></i>
                    Salva
                  </button>
                  <button class="btn btn-sm btn-secondary" (click)="cancelEdit()">
                    <i class="bi bi-x-lg me-1"></i>
                    Annulla
                  </button>
                }
              </div>

              <!-- Dati Auto -->
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Targa</label>
                  <input type="text" class="form-control text-uppercase" [value]="car()!.targa" disabled>
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Marca</label>
                  <input type="text" class="form-control text-uppercase" [(ngModel)]="car()!.marca" [disabled]="!editMode()">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Modello</label>
                  <input type="text" class="form-control text-uppercase" [(ngModel)]="car()!.modello" [disabled]="!editMode()">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Anno</label>
                  <input type="number" class="form-control" [(ngModel)]="car()!.anno" [disabled]="!editMode()">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Colore</label>
                  <input type="text" class="form-control text-uppercase" [(ngModel)]="car()!.colore" [disabled]="!editMode()">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Data di Acquisto</label>
                  <input type="date" class="form-control" [ngModel]="car()!.dataDiAcquisto | date:'yyyy-MM-dd'" (ngModelChange)="car()!.dataDiAcquisto = $event" [disabled]="!editMode()">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Prezzo di Acquisto</label>
                  <input type="number" class="form-control" [(ngModel)]="car()!.prezzoDiAcquisto" [disabled]="!editMode()">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Prezzo di Vendita</label>
                  <input type="number" class="form-control" [(ngModel)]="car()!.prezzoDiVendita" [disabled]="!editMode()">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Data di Vendita</label>
                  <input type="date" class="form-control" [ngModel]="car()!.dataDiVendita | date:'yyyy-MM-dd'" (ngModelChange)="car()!.dataDiVendita = $event" [disabled]="!editMode()">
                </div>
              </div>

              <!-- Proprietario -->
              <hr class="my-4">
              <h5 class="mb-3">Proprietario</h5>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold">Nome</label>
                  <input type="text" class="form-control" [value]="car()!.proprietario.nome" disabled>
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold">Cognome</label>
                  <input type="text" class="form-control" [value]="car()!.proprietario.cognome" disabled>
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold">Codice Fiscale</label>
                  <input type="text" class="form-control text-uppercase" [value]="car()!.proprietario.codiceFiscale" disabled>
                </div>
              </div>
            </div>
          }
        </div>

        <!-- SEZIONE COPROPRIETARI -->
        <div class="accordion-card">
          <div class="accordion-header" (click)="toggleCoproprietari()">
            <div class="d-flex align-items-center">
              <i class="bi bi-people-fill me-2"></i>
              <span class="accordion-title">Coproprietari</span>
            </div>
            <i class="bi" [class.bi-chevron-up]="coproprietariOpen()" [class.bi-chevron-down]="!coproprietariOpen()"></i>
          </div>

          @if (coproprietariOpen()) {
            <div class="accordion-body">
              
              <!-- Lista coproprietari esistenti -->
              @if (car()!.coProprietari.length > 0) {
                <h5 class="mb-3">Coproprietari attuali</h5>
                <div class="coproprietari-list mb-4">
                  @for (coproprietario of car()!.coProprietari; track coproprietario.codiceFiscale) {
                    <div class="coproprietario-item">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <div class="fw-bold">{{ coproprietario.nome }} {{ coproprietario.cognome }}</div>
                          <small class="text-muted text-uppercase">CF: {{ coproprietario.codiceFiscale }}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" (click)="removeCoproprietario(coproprietario.codiceFiscale)">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="alert alert-info" role="alert">
                  <i class="bi bi-info-circle me-2"></i>
                  Non ci sono coproprietari per questa auto.
                </div>
              }

              <!-- Pulsante aggiungi coproprietario -->
              <div class="mb-4">
                <button class="btn btn-primary w-100" (click)="toggleNewCoproprietarioForm()">
                  <i class="bi bi-plus-circle me-2"></i>
                  {{ showNewCoproprietarioForm() ? 'Annulla' : 'Aggiungi Coproprietario' }}
                </button>
              </div>

              <!-- Form nuovo coproprietario -->
              @if (showNewCoproprietarioForm()) {
                <div class="new-coproprietario-form">
                  <h5 class="mb-3">Nuovo Coproprietario</h5>
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">Nome *</label>
                      <input type="text" class="form-control text-uppercase" [(ngModel)]="newCoproprietario.nome">
                    </div>

                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">Cognome *</label>
                      <input type="text" class="form-control text-uppercase" [(ngModel)]="newCoproprietario.cognome">
                    </div>

                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">Codice Fiscale *</label>
                      <input type="text" class="form-control text-uppercase" [(ngModel)]="newCoproprietario.codiceFiscale" maxlength="16">
                    </div>

                    <div class="col-12 text-end">
                      <button class="btn btn-success" (click)="addCoproprietario()">
                        <i class="bi bi-plus-lg me-1"></i>
                        Aggiungi
                      </button>
                    </div>
                  </div>
                  <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Se l'utente non esiste verrà creato automaticamente nel sistema.
                  </small>
                </div>
              }

            </div>
          }
        </div>

        <!-- SEZIONE ASSICURAZIONI -->
        <div class="accordion-card">
          <div class="accordion-header" (click)="toggleAssicurazioni()">
            <div class="d-flex align-items-center">
              <i class="bi bi-shield-fill-check me-2"></i>
              <span class="accordion-title">Assicurazioni</span>
            </div>
            <i class="bi" [class.bi-chevron-up]="assicurazioniOpen()" [class.bi-chevron-down]="!assicurazioniOpen()"></i>
          </div>

          @if (assicurazioniOpen()) {
            <div class="accordion-body">
              
              <!-- Banner allarme nessuna assicurazione attiva -->
              @if (!hasAssicurazioneAttiva()) {
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                  <i class="bi bi-exclamation-triangle-fill fs-3 me-3"></i>
                  <div>
                    <strong>Attenzione!</strong> Questa auto non ha un'assicurazione attiva. 
                    Provvedi al più presto a stipularne una.
                  </div>
                </div>
              }

              <!-- Assicurazione attiva -->
              @if (hasAssicurazioneAttiva()) {
                <div class="assicurazione-attiva mb-4">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                      <i class="bi bi-shield-check text-success me-2"></i>
                      Assicurazione Attiva
                    </h5>
                    <button class="btn btn-sm btn-danger" (click)="deleteAssicurazione(getAssicurazioneAttiva()!.id)">
                      <i class="bi bi-trash me-1"></i>
                      Elimina
                    </button>
                  </div>

                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">Compagnia</label>
                      <input type="text" class="form-control text-uppercase" [(ngModel)]="getAssicurazioneAttiva()!.compagnia">
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">Numero Polizza</label>
                      <input type="text" class="form-control text-uppercase" [(ngModel)]="getAssicurazioneAttiva()!.numeroPolizza">
                    </div>

                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">Data Inizio</label>
                      <input type="date" class="form-control" [ngModel]="getAssicurazioneAttiva()!.dataInizio | date:'yyyy-MM-dd'" (ngModelChange)="getAssicurazioneAttiva()!.dataInizio = $event">
                    </div>

                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">Data Fine</label>
                      <input type="date" class="form-control" [ngModel]="getAssicurazioneAttiva()!.dataFine | date:'yyyy-MM-dd'" (ngModelChange)="getAssicurazioneAttiva()!.dataFine = $event">
                    </div>

                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">Costo Annuale (€)</label>
                      <input type="number" class="form-control" [(ngModel)]="getAssicurazioneAttiva()!.costoAnnuale">
                    </div>

                    <div class="col-12 text-end">
                      <button class="btn btn-sm btn-success" (click)="updateAssicurazione(getAssicurazioneAttiva()!)">
                        <i class="bi bi-check-lg me-1"></i>
                        Salva Modifiche
                      </button>
                    </div>
                  </div>
                </div>
              }

              <!-- Pulsante aggiungi nuova assicurazione -->
              <div class="mb-4">
                <button class="btn btn-primary w-100" (click)="toggleNewAssicurazioneForm()">
                  <i class="bi bi-plus-circle me-2"></i>
                  {{ showNewAssicurazioneForm() ? 'Annulla' : 'Aggiungi Nuova Assicurazione' }}
                </button>
              </div>

              <!-- Form nuova assicurazione -->
              @if (showNewAssicurazioneForm()) {
                <div class="new-assicurazione-form mb-4">
                  <h5 class="mb-3">Nuova Assicurazione</h5>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">Compagnia *</label>
                      <input type="text" class="form-control text-uppercase" [(ngModel)]="newAssicurazione.compagnia">
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">Numero Polizza *</label>
                      <input type="text" class="form-control text-uppercase" [(ngModel)]="newAssicurazione.numeroPolizza">
                    </div>

                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">Data Inizio *</label>
                      <input type="date" class="form-control" [(ngModel)]="newAssicurazione.dataInizio">
                    </div>

                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">Data Fine *</label>
                      <input type="date" class="form-control" [(ngModel)]="newAssicurazione.dataFine">
                    </div>

                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">Costo Annuale (€) *</label>
                      <input type="number" class="form-control" [(ngModel)]="newAssicurazione.costoAnnuale">
                    </div>

                    <div class="col-12 text-end">
                      <button class="btn btn-success" (click)="addAssicurazione()">
                        <i class="bi bi-plus-lg me-1"></i>
                        Aggiungi
                      </button>
                    </div>
                  </div>
                </div>
              }

              <!-- Storico assicurazioni -->
              @if (getStoricoAssicurazioni().length > 0) {
                <hr class="my-4">
                <h5 class="mb-3">Storico Assicurazioni</h5>
                
                @for (assicurazione of getStoricoAssicurazioni(); track assicurazione.id) {
                  <div class="assicurazione-storico mb-3">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                        <div class="row">
                          <div class="col-md-4">
                            <strong>Compagnia:</strong> {{ assicurazione.compagnia }}
                          </div>
                          <div class="col-md-4">
                            <strong>Polizza:</strong> {{ assicurazione.numeroPolizza }}
                          </div>
                          <div class="col-md-4">
                            <strong>Costo:</strong> {{ formatPrice(assicurazione.costoAnnuale) }}
                          </div>
                          <div class="col-md-6 mt-2">
                            <strong>Periodo:</strong> {{ formatDate(assicurazione.dataInizio) }} - {{ formatDate(assicurazione.dataFine) }}
                          </div>
                        </div>
                      </div>
                      <button class="btn btn-sm btn-outline-danger ms-3" (click)="deleteAssicurazione(assicurazione.id)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                }
              }
            </div>
          }
        </div>

        <!-- SEZIONE TAGLIANDI -->
        <div class="accordion-card">
          <div class="accordion-header" (click)="toggleTagliandi()">
            <div class="d-flex align-items-center">
              <i class="bi bi-wrench-adjustable-circle-fill me-2"></i>
              <span class="accordion-title">Tagliandi</span>
            </div>
            <i class="bi" [class.bi-chevron-up]="tagliandiOpen()" [class.bi-chevron-down]="!tagliandiOpen()"></i>
          </div>

          @if (tagliandiOpen()) {
            <div class="accordion-body">
              
              <!-- Pulsante aggiungi tagliando -->
              <div class="mb-4">
                <button class="btn btn-primary w-100" (click)="toggleNewTagliandoForm()">
                  <i class="bi bi-plus-circle me-2"></i>
                  {{ showNewTagliandoForm() ? 'Annulla' : 'Aggiungi Nuovo Tagliando' }}
                </button>
              </div>

              <!-- Form nuovo tagliando -->
              @if (showNewTagliandoForm()) {
                <div class="new-tagliando-form mb-4">
                  <h5 class="mb-3">Nuovo Tagliando</h5>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">Data *</label>
                      <input type="date" class="form-control" [(ngModel)]="newTagliando.data">
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">Chilometraggio *</label>
                      <input type="number" class="form-control" [(ngModel)]="newTagliando.chilometraggio" min="0">
                    </div>

                    <div class="col-md-12 mb-3">
                      <label class="form-label fw-bold">Descrizione *</label>
                      <textarea 
                        class="form-control text-uppercase" 
                        [(ngModel)]="newTagliando.descrizione" 
                        rows="4"
                        placeholder="Descrivi le operazioni effettuate (es. CAMBIO OLIO, FILTRI, PASTIGLIE FRENO...)"></textarea>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">Costo (€) *</label>
                      <input type="number" class="form-control" [(ngModel)]="newTagliando.costo" min="0" step="0.01">
                    </div>

                    <div class="col-12 text-end">
                      <button class="btn btn-success" (click)="addTagliando()">
                        <i class="bi bi-plus-lg me-1"></i>
                        Aggiungi
                      </button>
                    </div>
                  </div>
                </div>
              }

              <!-- Storico tagliandi -->
              @if (getTagliandiOrdinati().length > 0) {
                <h5 class="mb-3">Storico Tagliandi</h5>
                
                @for (tagliando of getTagliandiOrdinati(); track tagliando.id) {
                  <div class="tagliando-item mb-3">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                        <div class="row">
                          <div class="col-md-3">
                            <strong>Data:</strong> {{ formatDate(tagliando.data) }}
                          </div>
                          <div class="col-md-3">
                            <strong>Km:</strong> {{ tagliando.chilometraggio.toLocaleString('it-IT') }}
                          </div>
                          <div class="col-md-3">
                            <strong>Costo:</strong> {{ formatPrice(tagliando.costo) }}
                          </div>
                          <div class="col-12 mt-2">
                            <strong>Descrizione:</strong>
                            <p class="mb-0 mt-1 text-muted">{{ tagliando.descrizione }}</p>
                          </div>
                        </div>
                      </div>
                      <button class="btn btn-sm btn-outline-danger ms-3" (click)="deleteTagliando(tagliando.id)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                }
              } @else {
                <div class="alert alert-info" role="alert">
                  <i class="bi bi-info-circle me-2"></i>
                  Non ci sono tagliandi registrati per questa auto.
                </div>
              }

            </div>
          }
        </div>

      </div>
    }
  </div>
</div>
